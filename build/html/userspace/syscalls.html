

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Interaction Between BOLOS and Apps &mdash; Ledger Documentation Hub 2 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Application Structure and I/O" href="application_structure.html" />
    <link rel="prev" title="Advanced Display Management" href="advanced_display_management.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Ledger Documentation Hub
          

          
          </a>

          
            
            
              <div class="version">
                2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Background Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../background/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/personal_security_devices.html">Personal Security Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/master_seed.html">The Master Seed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/hd_keys.html">HD Key Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/hd_use_cases.html">Applications of HD Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/application_isolation.html">Application Isolation</a></li>
</ul>
<p class="caption"><span class="caption-text">BOLOS Platform</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../bolos/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bolos/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bolos/features.html">BOLOS Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bolos/hardware_architecture.html">Hardware Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bolos/application_environment.html">Application Environment</a></li>
</ul>
<p class="caption"><span class="caption-text">Userspace Development</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing_apps.html">Writing Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="display_management.html">Display Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced_display_management.html">Advanced Display Management</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Interaction Between BOLOS and Apps</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#error-model">Error Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#syscall-requirements">Syscall Requirements</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="application_structure.html">Application Structure and I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="memory.html">Persistent Storage and PIC</a></li>
<li class="toctree-l1"><a class="reference internal" href="alignment.html">Memory alignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Common Pitfalls and Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Application Debug</a></li>
<li class="toctree-l1"><a class="reference internal" href="speculos.html">Emulating devices with Speculos</a></li>
</ul>
<p class="caption"><span class="caption-text">Additional Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../additional/publishing_an_app.html">Publishing an Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional/external_docs.html">External Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional/security_guidelines.html">Developing Secure Ledger Apps</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ledger Documentation Hub</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Interaction Between BOLOS and Apps</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/userspace/syscalls.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="interaction-between-bolos-and-apps">
<h1>Interaction Between BOLOS and Apps<a class="headerlink" href="#interaction-between-bolos-and-apps" title="Permalink to this headline">¶</a></h1>
<p>Since BOLOS is designed based on a single-task model where only a single app
runs at any given time, an application is independently responsible for a lot of
the things a typical OS would do. These things include managing hardware like
the device screen, buttons, timer, etc. as well as handling all I/O with
peripherals. However, there are many instances where a BOLOS application has to
request the operating system to perform a certain operation. This is done using
a syscall.</p>
<p>When an application performs a syscall, the Secure Element switches to
Supervisor mode and the OS performs the requested task before returning control
back to the application, in User mode. All syscalls have a wrapper function in
the SDK that can be used to invoke them. A syscall may be used to access
hardware accelerated cryptographic primitives (most of these functions are
defined in <code class="docutils literal notranslate"><span class="pre">include/cx.h</span></code> in the SDKs), to perform low-level I/O operations
(like receiving / transmitting to the MCU), or to access cryptographic secrets
managed by BOLOS (for example, to derive a node from the BIP 32 master node).</p>
<div class="section" id="error-model">
<h2>Error Model<a class="headerlink" href="#error-model" title="Permalink to this headline">¶</a></h2>
<p>If you are familiar with C programming, you will be used to error codes as the
default error model. However, when programming in the embedded world, this
traditional model reaches its limits, and can quickly overcomplicate large
codebases. Therefore, we’ve implemented a try / catch system that supports
nesting (direct or transitive) using the <code class="docutils literal notranslate"><span class="pre">setjmp</span></code> and <code class="docutils literal notranslate"><span class="pre">longjmp</span></code> API to
facilitate writing robust code.</p>
<p>Here is an example of a typical try / catch / finally construct:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">BEGIN_TRY</span> <span class="p">{</span>
    <span class="n">TRY</span> <span class="p">{</span>
        <span class="c1">// Perform some operation that may throw an error using THROW(...)</span>
    <span class="p">}</span> <span class="n">CATCH_OTHER</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Handle error</span>
    <span class="p">}</span> <span class="n">FINALLY</span> <span class="p">{</span>
        <span class="c1">// Always executed before continuing control flow</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="n">END_TRY</span><span class="p">;</span>
</pre></div>
</div>
<p>However there is a single constraint to be aware of with our try / catch system:
a <code class="docutils literal notranslate"><span class="pre">TRY</span></code> clause must always be closed in the appropriate way. This means that
if using a return, break, continue or goto statement that jumps out of the
<code class="docutils literal notranslate"><span class="pre">TRY</span></code> clause you MUST manually close it, or it could lead to a crash of the
application in a later <code class="docutils literal notranslate"><span class="pre">THROW</span></code>. A <code class="docutils literal notranslate"><span class="pre">TRY</span></code> clause can be manually closed using
<code class="docutils literal notranslate"><span class="pre">CLOSE_TRY</span></code>. Using <code class="docutils literal notranslate"><span class="pre">CLOSE_TRY</span></code> is only necessary when jumping out of a
<code class="docutils literal notranslate"><span class="pre">TRY</span></code> clause, jumping out of a <code class="docutils literal notranslate"><span class="pre">CATCH</span></code> or <code class="docutils literal notranslate"><span class="pre">FINALLY</span></code> clause is allowed (but
still, be careful you’re not in a <code class="docutils literal notranslate"><span class="pre">CATCH</span></code> nested in a <code class="docutils literal notranslate"><span class="pre">TRY</span></code>).</p>
<p>You should use the error codes defined in the SDKs wherever possible (see
<code class="docutils literal notranslate"><span class="pre">EXCEPTION</span></code>, <code class="docutils literal notranslate"><span class="pre">INVALID_PARAMETER</span></code>, etc. in <code class="docutils literal notranslate"><span class="pre">os.h</span></code>). If you decide to use
custom error codes, never use an error code of <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
<p>Developers should avoid creating a new try context wherever possible in order to
reduce code size and stack usage. Preferably, an application should only have a
single top-level try context at the application entry point (in <code class="docutils literal notranslate"><span class="pre">main()</span></code>).</p>
</div>
<div class="section" id="syscall-requirements">
<h2>Syscall Requirements<a class="headerlink" href="#syscall-requirements" title="Permalink to this headline">¶</a></h2>
<p>BOLOS is based on an exception model for error reporting, therefore, it expects
the application to call the BOLOS API using this mechanism. If an API function
is called from outside a <code class="docutils literal notranslate"><span class="pre">TRY</span></code> context, then the BOLOS call is denied.</p>
<p>Here is a valid way to call a system entry point:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">BEGIN_TRY</span> <span class="p">{</span>
    <span class="n">TRY</span> <span class="p">{</span>
        <span class="n">cx_hash_sha512</span><span class="p">(...);</span>
    <span class="p">}</span> <span class="n">FINALLY</span> <span class="p">{}</span>
<span class="p">}</span> <span class="n">END_TRY</span><span class="p">;</span>
</pre></div>
</div>
<p>However, as mentioned above, it is preferred to use as few try contexts as
possible (not one per syscall). A single, top-level try context can be used to
catch any exception thrown by any syscall performed by the application.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="application_structure.html" class="btn btn-neutral float-right" title="Application Structure and I/O" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="advanced_display_management.html" class="btn btn-neutral float-left" title="Advanced Display Management" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2016 - 2019, Ledger Team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>