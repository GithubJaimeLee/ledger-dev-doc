

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Persistent Storage and PIC &mdash; Ledger Documentation Hub 2 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Memory alignment" href="alignment.html" />
    <link rel="prev" title="Application Structure and I/O" href="application_structure.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Ledger Documentation Hub
          

          
          </a>

          
            
            
              <div class="version">
                2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Background Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../background/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/personal_security_devices.html">Personal Security Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/master_seed.html">The Master Seed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/hd_keys.html">HD Key Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/hd_use_cases.html">Applications of HD Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/application_isolation.html">Application Isolation</a></li>
</ul>
<p class="caption"><span class="caption-text">BOLOS Platform</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../bolos/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bolos/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bolos/features.html">BOLOS Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bolos/hardware_architecture.html">Hardware Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bolos/application_environment.html">Application Environment</a></li>
</ul>
<p class="caption"><span class="caption-text">Userspace Development</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing_apps.html">Writing Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="display_management.html">Display Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced_display_management.html">Advanced Display Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="syscalls.html">Interaction Between BOLOS and Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="application_structure.html">Application Structure and I/O</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Persistent Storage and PIC</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#types-of-memory">Types of Memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="#flash-memory-endurance">Flash Memory Endurance</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pic-and-model-implications">PIC and Model Implications</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="alignment.html">Memory alignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Common Pitfalls and Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Application Debug</a></li>
<li class="toctree-l1"><a class="reference internal" href="speculos.html">Emulating devices with Speculos</a></li>
</ul>
<p class="caption"><span class="caption-text">Additional Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../additional/publishing_an_app.html">Publishing an Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional/external_docs.html">External Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional/security_guidelines.html">Developing Secure Ledger Apps</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ledger Documentation Hub</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Persistent Storage and PIC</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/userspace/memory.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="persistent-storage-and-pic">
<h1>Persistent Storage and PIC<a class="headerlink" href="#persistent-storage-and-pic" title="Permalink to this headline">¶</a></h1>
<p>BOLOS applications have access to two different types of memory in the Secure
Element: a small amount of RAM for the call stack and certain global variables,
and a considerably larger amount of flash memory for persistent storage. Access
to flash memory is regulated by the Memory Protection Unit which is configured
by BOLOS to prevent applications from tampering with parts of flash memory that
they shouldn’t. However, applications are able to access the part of flash
memory where their constant data and code is defined. This data includes code
and <code class="docutils literal notranslate"><span class="pre">const</span></code> variables, but applications may also allocate extra space in NVRAM
to be used at runtime for persistent storage.</p>
<div class="section" id="types-of-memory">
<h2>Types of Memory<a class="headerlink" href="#types-of-memory" title="Permalink to this headline">¶</a></h2>
<p>All global variables that are declared as <code class="docutils literal notranslate"><span class="pre">const</span></code> are stored in read-only
flash memory, right next to code. All normal global variables that are declared
as non-<code class="docutils literal notranslate"><span class="pre">const</span></code> are stored in RAM. However, thanks to the link script
(<code class="docutils literal notranslate"><span class="pre">script.ld</span></code>) in the SDK, global variables that are declared as non-<code class="docutils literal notranslate"><span class="pre">const</span></code>
and are given the prefix <code class="docutils literal notranslate"><span class="pre">N_</span></code> are placed in a special write-permitted location
of NVRAM. This data can be read in the same way that regular global variables
are read. However, writing to NVRAM variables must be done using the
<code class="docutils literal notranslate"><span class="pre">nvm_write(...)</span></code> function defined by the SDK, which performs a syscall. When
loading the app, NVRAM variables are initialized with data specified in the
app’s hex file (this is usually just zero bytes).</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Initializers of global non-<code class="docutils literal notranslate"><span class="pre">const</span></code> variables (including NVRAM variables)
are ignored. As such, this data must be initialized by application code.</p>
</div>
</div>
<div class="section" id="flash-memory-endurance">
<span id="id1"></span><h2>Flash Memory Endurance<a class="headerlink" href="#flash-memory-endurance" title="Permalink to this headline">¶</a></h2>
<p>The flash memory for the <a class="reference external" href="http://www.st.com/en/secure-mcus/st31g480.html">ST31G480</a>, which is the Secure Element
used in the Ledger Blue, is rated for 500 000 erase / write cycles. This should
be more than enough to last the expected lifetime of the device, but only if
applications use it properly. Applications should avoid erasures as much as
possible. Here are some techniques for avoiding wearing out the device’s flash
memory.</p>
<p>Firstly, if you intend to be changing data in flash memory many times while an
application is running, consider caching the data in RAM and then flushing to
flash memory when the application has finished its operation. This of course has
the downside of possible data loss if the user powers off the device (perhaps by
unplugging it, in the case of the Nano S) before the data has been written to
persistent storage. Secondly, developers should be aware that flash memory pages
are aligned to 64-byte boundaries. The rating of 500 000 erase / write cycles
mentioned earlier means that each page in flash memory is expected to survive
500 000 erasures. As such, one can develop an application that writes to as few
pages as possible. For example, if you intend to store 32 bytes of data in flash
memory, write amplification can be avoided by making sure that 32 bytes of data
is contained entirely within a single page (and modified using only a single
call to <code class="docutils literal notranslate"><span class="pre">nvm_write(...)</span></code>). If the data crossed a 64-byte page boundary, then
writing to it once may require two pages to be erased instead of just one.</p>
<p>In the future, Ledger will provide various persistent storage utilities within
BOLOS and the SDKs to simplify the process of using flash memory efficiently.</p>
</div>
<div class="section" id="pic-and-model-implications">
<h2>PIC and Model Implications<a class="headerlink" href="#pic-and-model-implications" title="Permalink to this headline">¶</a></h2>
<p>PIC stands for Position-Independent Code. The BOLOS toolchain produces PIC to
allow for the code <strong>Link address</strong> to be different from the code <strong>Execution
address</strong>. For example, the <code class="docutils literal notranslate"><span class="pre">main</span></code> function is linked in the generated
application at address <code class="docutils literal notranslate"><span class="pre">0xC0D00000</span></code>. However, the slot used when loaded into
the Secure Element could be <code class="docutils literal notranslate"><span class="pre">0x10E40400</span></code>. Therefore, if the code makes a
reference to <code class="docutils literal notranslate"><span class="pre">0xC0D00000</span></code>, even with an offset, it would be denied access as
the application is locked by the Memory Protection Unit (not to mention, this is
not the correct address of the <code class="docutils literal notranslate"><span class="pre">main</span></code> function at runtime).</p>
<p>The PIC assembly generator makes sure every dereference is relative to the
Program Counter, and never to an arbitrary address resolved during the link
stage. This behavior is supported by clang versions 4.0.0 and later.</p>
<p>Traditionally, PIC code implies the BSS segment (RAM variables) is at a constant
offset of the code. For example, if code is at <code class="docutils literal notranslate"><span class="pre">0xC0D00000</span></code>, then global vars
may be at <code class="docutils literal notranslate"><span class="pre">0xC2D00000</span></code>, so if loaded at <code class="docutils literal notranslate"><span class="pre">0x10E00000</span></code> then global vars would
be at <code class="docutils literal notranslate"><span class="pre">0x12E00000</span></code>. However, BOLOS uses a fixed address for global vars. The
global variables start address and length are defined in the link script. Only
the code is meant to be placed at different addresses (in flash memory, rather
than RAM).</p>
<p>The model we chose has limitations, which are related to the way <code class="docutils literal notranslate"><span class="pre">const</span></code> data
and code is referenced in other <code class="docutils literal notranslate"><span class="pre">const</span></code> data. Here is a simple example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">char</span> <span class="n">array1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">};</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">array2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">};</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">array_2d</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">array1</span><span class="p">,</span> <span class="n">array2</span><span class="p">};</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">sum</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
    <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sum</span> <span class="o">+=</span> <span class="n">array_2d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span> <span class="c1">// Segmentation Fault!</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the example above, when dereferencing <code class="docutils literal notranslate"><span class="pre">array_2d</span></code>, the compiler uses a
link-time address (in the <code class="docutils literal notranslate"><span class="pre">0xC0D00000</span></code> space, following the previous
examples). This is not where the program is loaded in memory at runtime.
Therefore, when the dereference is executed, it causes a segmentation fault that
effectively stalls the SE. Luckily, the solution is pretty simple, thanks to a
small piece of assembly provided with the SDKs which is invoked with the
<code class="docutils literal notranslate"><span class="pre">PIC(...)</span></code> macro. <code class="docutils literal notranslate"><span class="pre">PIC(...)</span></code> uses the current load address to adjust the
link-time address in order to acquire the correct runtime address of <code class="docutils literal notranslate"><span class="pre">const</span></code>
data and code. The above examples can be corrected by modifying the line where
<code class="docutils literal notranslate"><span class="pre">array_2d</span></code> is dereferenced to do the following:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sum</span> <span class="o">+=</span> <span class="p">((</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">PIC</span><span class="p">(</span><span class="n">array_2d</span><span class="p">[</span><span class="n">i</span><span class="p">]))[</span><span class="n">j</span><span class="p">];</span>
</pre></div>
</div>
<p>The same mechanism must be applied when storing function pointers in <code class="docutils literal notranslate"><span class="pre">const</span></code>
data. The PIC call cast is just different. Additionally, if a non-link-time
address is passed to <code class="docutils literal notranslate"><span class="pre">PIC(...)</span></code>, then it will be preserved. This is possible
due to the wisely chosen link-time address which is beyond both real RAM and
loadable addresses. For example, <code class="docutils literal notranslate"><span class="pre">PIC(...)</span></code> is used during a call to
<code class="docutils literal notranslate"><span class="pre">io_seproxyhal_display_default(...)</span></code>, all display elements can hold a
reference to a string to be displayed with the element, and the string could be
in RAM or code, and therefore <code class="docutils literal notranslate"><span class="pre">PIC(...)</span></code> is applied to acquire the correct
runtime address of the string, even if it’s in RAM.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="alignment.html" class="btn btn-neutral float-right" title="Memory alignment" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="application_structure.html" class="btn btn-neutral float-left" title="Application Structure and I/O" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2016 - 2019, Ledger Team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>