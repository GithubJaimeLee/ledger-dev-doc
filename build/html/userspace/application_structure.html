

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Application Structure and I/O &mdash; Ledger Documentation Hub 2 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Persistent Storage and PIC" href="memory.html" />
    <link rel="prev" title="Interaction Between BOLOS and Apps" href="syscalls.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Ledger Documentation Hub
          

          
          </a>

          
            
            
              <div class="version">
                2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Background Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../background/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/personal_security_devices.html">Personal Security Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/master_seed.html">The Master Seed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/hd_keys.html">HD Key Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/hd_use_cases.html">Applications of HD Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/application_isolation.html">Application Isolation</a></li>
</ul>
<p class="caption"><span class="caption-text">BOLOS Platform</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../bolos/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bolos/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bolos/features.html">BOLOS Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bolos/hardware_architecture.html">Hardware Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bolos/application_environment.html">Application Environment</a></li>
</ul>
<p class="caption"><span class="caption-text">Userspace Development</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing_apps.html">Writing Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="display_management.html">Display Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced_display_management.html">Advanced Display Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="syscalls.html">Interaction Between BOLOS and Apps</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Application Structure and I/O</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#apdu-interpretation-loop">APDU Interpretation Loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="#protocols">Protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="#unprocessed-events">Unprocessed Events</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="memory.html">Persistent Storage and PIC</a></li>
<li class="toctree-l1"><a class="reference internal" href="alignment.html">Memory alignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Common Pitfalls and Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Application Debug</a></li>
<li class="toctree-l1"><a class="reference internal" href="speculos.html">Emulating devices with Speculos</a></li>
</ul>
<p class="caption"><span class="caption-text">Additional Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../additional/publishing_an_app.html">Publishing an Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional/external_docs.html">External Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional/security_guidelines.html">Developing Secure Ledger Apps</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ledger Documentation Hub</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Application Structure and I/O</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/userspace/application_structure.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="application-structure-and-i-o">
<h1>Application Structure and I/O<a class="headerlink" href="#application-structure-and-i-o" title="Permalink to this headline">¶</a></h1>
<p>Many of the existing BOLOS applications are based on a smartcard architecture.
This is because BOLOS applications are not meant to run standalone, but rather
assist a host process (on a computer / smartphone) to perform a secure task
(signing a message, encryption / decryption, etc.). Therefore the device is
commonly addressed using a command / response scheme. Numerous design decisions
have been made when developing the SDKs in order to support this model.</p>
<p>However, the Event / Commands / Status model is designed to avoid limitations on
the application, as it does not follow the command / response synchronous model.
Developers are free to work around the model and redesign a custom event
processing loop to suit their needs.</p>
<div class="section" id="apdu-interpretation-loop">
<h2>APDU Interpretation Loop<a class="headerlink" href="#apdu-interpretation-loop" title="Permalink to this headline">¶</a></h2>
<p>The command / response scheme used to address the device is similar to the
<a class="reference external" href="https://en.wikipedia.org/wiki/Smart_card_application_protocol_data_unit">ISO/IEC 7816-4</a>
smartcard protocol. Each command / response packet is called an APDU. The
application is driven by a never-ending APDU interpretation loop called straight
from the application main function.</p>
<p>Each cycle of the APDU interpretation loop calls <code class="docutils literal notranslate"><span class="pre">io_exchange(...)</span></code> from the
SDK, which first sends a response APDU (unless it’s the first call, in which
case it sends nothing), and then receives the next command APDU.</p>
<p>However, sometimes, a user confirmation to perform a security action must be
performed before replying to an APDU (for example, when signing a message). Such
behavior is handled by replying no data to the command in the APDU interpreter
by using the <code class="docutils literal notranslate"><span class="pre">IO_ASYNCH_REPLY</span></code> flag, then following the user action calling
<code class="docutils literal notranslate"><span class="pre">io_exchange</span></code> with the <code class="docutils literal notranslate"><span class="pre">IO_RETURN_AFTER_TX</span></code> flag and with the amount of data
to reply to the stalled command.</p>
<p>For an example of this feature, refer to <a class="reference external" href="https://github.com/LedgerHQ/blue-sample-apps/blob/2fb0f8f68ef68bbecd601cf476e532177288a0fa/blue-app-samplesign/src/main.c">blue-app-samplesign</a>.
In this app, when the command APDU to sign a message is received (line 510), the
flag <code class="docutils literal notranslate"><span class="pre">IO_ASYNCH_REPLY</span></code> is set and no response APDU is sent. If the user
approves the action, then the button push handler calls
<code class="docutils literal notranslate"><span class="pre">io_seproxyhal_touch_approve(...)</span></code> which sends the response APDU using another
call to <code class="docutils literal notranslate"><span class="pre">io_exchange(...)</span></code> with the <code class="docutils literal notranslate"><span class="pre">IO_RETURN_AFTER_TX</span></code> flag set (line
434). The same occurs if the user denies the action, in which case
<code class="docutils literal notranslate"><span class="pre">io_seproxyhal_touch_deny(...)</span></code> is triggered.</p>
</div>
<div class="section" id="protocols">
<h2>Protocols<a class="headerlink" href="#protocols" title="Permalink to this headline">¶</a></h2>
<p>It’s important to understand that the APDU protocol used by most BOLOS
applications is not implemented by BOLOS itself. Instead, the APDU
interpretation is performed entirely by the SDK. This means that applications
can choose to implement another protocol on top of the transport layer (USB HID,
USB CCID, BLE, …) instead of APDU. In fact, the same is true for the transport
layer protocols. Applications can customize the way the application is
enumerated as a USB device by the host.</p>
<div class="figure align-center" id="id1">
<img alt="../_images/common_protocols.png" src="../_images/common_protocols.png" />
<p class="caption"><span class="caption-text">Common protocols across BOLOS applications</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="unprocessed-events">
<h2>Unprocessed Events<a class="headerlink" href="#unprocessed-events" title="Permalink to this headline">¶</a></h2>
<p>APDU processing relies on the BOLOS way of framing / transporting APDU packets.
All event processing related to transfer operations (including USB) is performed
within <code class="docutils literal notranslate"><span class="pre">io_exchange(...)</span></code>. Not considering customization of the transport,
some Events are not automagically processed by <code class="docutils literal notranslate"><span class="pre">io_exchange(...)</span></code> (for
example: Button Push Events, Display Processed Events, Ticker Events, …). In
order to handle these events that cannot be handled automagically,
<code class="docutils literal notranslate"><span class="pre">io_exchange(...)</span></code> calls <code class="docutils literal notranslate"><span class="pre">io_event(...)</span></code> which is defined by the application
(not by the SDK).</p>
<p>Developers must take great care in the way they process Events. Events might
occur in the middle of APDU transport (most likely Button Push or Ticker
Events). As such, <code class="docutils literal notranslate"><span class="pre">io_event(...)</span></code> must return <code class="docutils literal notranslate"><span class="pre">1</span></code> if events are expected,
otherwise the current APDU transport will be terminated (this feature could be
used to implement a timeout, for example).</p>
<p>Thanks to a hardware buffer in the SE, it is impossible to miss an Event packet.
And, due to the E/Cs/S protocol design, no Event will be sent by the MCU until a
new Status is sent by the application.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="memory.html" class="btn btn-neutral float-right" title="Persistent Storage and PIC" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="syscalls.html" class="btn btn-neutral float-left" title="Interaction Between BOLOS and Apps" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2016 - 2019, Ledger Team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>