

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Application Debug &mdash; Ledger Documentation Hub 2 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Emulating devices with Speculos" href="speculos.html" />
    <link rel="prev" title="Common Pitfalls and Troubleshooting" href="troubleshooting.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Ledger Documentation Hub
          

          
          </a>

          
            
            
              <div class="version">
                2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Background Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../background/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/personal_security_devices.html">Personal Security Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/master_seed.html">The Master Seed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/hd_keys.html">HD Key Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/hd_use_cases.html">Applications of HD Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/application_isolation.html">Application Isolation</a></li>
</ul>
<p class="caption"><span class="caption-text">BOLOS Platform</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../bolos/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bolos/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bolos/features.html">BOLOS Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bolos/hardware_architecture.html">Hardware Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bolos/application_environment.html">Application Environment</a></li>
</ul>
<p class="caption"><span class="caption-text">Userspace Development</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing_apps.html">Writing Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="display_management.html">Display Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced_display_management.html">Advanced Display Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="syscalls.html">Interaction Between BOLOS and Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="application_structure.html">Application Structure and I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="memory.html">Persistent Storage and PIC</a></li>
<li class="toctree-l1"><a class="reference internal" href="alignment.html">Memory alignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Common Pitfalls and Troubleshooting</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Application Debug</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#printf-macro">PRINTF macro</a></li>
<li class="toctree-l2"><a class="reference internal" href="#console-printing">Console Printing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pin-bypass">PIN bypass</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="speculos.html">Emulating devices with Speculos</a></li>
</ul>
<p class="caption"><span class="caption-text">Additional Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../additional/publishing_an_app.html">Publishing an Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional/external_docs.html">External Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional/security_guidelines.html">Developing Secure Ledger Apps</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ledger Documentation Hub</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Application Debug</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/userspace/debugging.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="application-debug">
<h1>Application Debug<a class="headerlink" href="#application-debug" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ledger has developed its own emulator called <a class="reference external" href="https://github.com/LedgerHQ/speculos">Speculos</a> .
Feel free to checkout:</p>
<ol class="arabic simple">
<li><p>The <a class="reference external" href="https://github.com/LedgerHQ/speculos">Speculos repo</a> .</p></li>
<li><p>The <a class="reference external" href="https://github.com/LedgerHQ/nanos-secure-sdk">Nano S SDK</a> and the <a class="reference external" href="https://github.com/LedgerHQ/nanox-secure-sdk">Nano X SDK</a> .</p></li>
<li><p>The <a class="reference internal" href="speculos.html"><span class="doc">Emulating devices with Speculos</span></a> section which gives an overview of how to use speculos.</p></li>
</ol>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <a class="reference internal" href="setup.html"><span class="doc">BOLOS development environment</span></a> is
required for the following article. It applies only for the Nano S, with its
SE firmware either in version 1.5.5 or 1.6.0.</p>
</div>
<p>It is possible to install a debugging firmware on the device’s MCU that will
enable printing text outputs from the device to a terminal. To do so, follow
these steps:</p>
<p>1. First, download the <a class="reference external" href="https://drive.google.com/open?id=1pbqIDDuamfsvFuEkduCyOFq8mW0HZmeQ">updater</a> and the
<a class="reference external" href="https://drive.google.com/open?id=1hTZKqlwKjx51vdqda8SRp_80Yx3lPizb">debug firmware</a> .</p>
<p>2. Exit any instance of Ledger Live, Ledger Chrome App, or any other program
able to communicate with a Ledger device.</p>
<p>3. Now, plug your Nano S to your computer while keeping the left button
pressed. Keep it pressed until the screen displays <code class="docutils literal notranslate"><span class="pre">BOOTLOADER</span></code>.</p>
<p>4. Fire a terminal and move to the directory containing the files downloaded at
step 1.</p>
<ol class="arabic" start="5">
<li><p>Install the updater (only if you MCU firmware is not already in version 1.11, otherwise just go to step 6):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">ledgerblue</span><span class="o">.</span><span class="n">loadMCU</span> <span class="o">--</span><span class="n">targetId</span> <span class="mh">0x01000001</span> <span class="o">--</span><span class="n">fileName</span> <span class="n">blup_0</span><span class="o">.</span><span class="mi">11</span><span class="n">_misc_m1</span><span class="o">.</span><span class="n">hex</span> <span class="o">--</span><span class="n">nocrc</span>
</pre></div>
</div>
</li>
</ol>
<p>Wait until <code class="docutils literal notranslate"><span class="pre">BOOTLOADER</span></code> is displayed again on the device’s screen.</p>
<ol class="arabic" start="6">
<li><p>Install the debug firmware:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">ledgerblue</span><span class="o">.</span><span class="n">loadMCU</span> <span class="o">--</span><span class="n">targetId</span> <span class="mh">0x01000001</span> <span class="o">--</span><span class="n">fileName</span> <span class="n">mcu_1</span><span class="o">.</span><span class="mi">11</span><span class="o">-</span><span class="n">printf_over_0</span><span class="o">.</span><span class="mf">11.</span><span class="n">hex</span> <span class="o">--</span><span class="n">reverse</span> <span class="o">--</span><span class="n">nocrc</span>
</pre></div>
</div>
</li>
</ol>
<p>If you can notice a small <code class="docutils literal notranslate"><span class="pre">dbg</span></code> block at the bottom of the screen, then it’s
a success !</p>
<div class="figure align-center" id="id2">
<a class="reference internal image-reference" href="../_images/debug_nano.jpg"><img alt="../_images/debug_nano.jpg" src="../_images/debug_nano.jpg" style="width: 500.0px; height: 186.5px;" /></a>
<p class="caption"><span class="caption-text">A Nano S with special debug firmware</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>Uninstalling this special firmware is also very easy, first you need to
download the <a class="reference external" href="https://drive.google.com/open?id=1YfdU1dNycojdtuKU_hHctLFzJZzhDFuY">normal firmware</a>,
then you can repeat the installation steps 2 to 5.</p>
<p>Finally, flash the normal firmware with this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">ledgerblue</span><span class="o">.</span><span class="n">loadMCU</span> <span class="o">--</span><span class="n">targetId</span> <span class="mh">0x01000001</span> <span class="o">--</span><span class="n">fileName</span> <span class="n">mcu_1</span><span class="o">.</span><span class="mi">11</span><span class="n">_over_0</span><span class="o">.</span><span class="mf">11.</span><span class="n">hex</span> <span class="o">--</span><span class="n">reverse</span> <span class="o">--</span><span class="n">nocrc</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">dbg</span></code> block should now be gone.</p>
<div class="section" id="printf-macro">
<h2>PRINTF macro<a class="headerlink" href="#printf-macro" title="Permalink to this headline">¶</a></h2>
<p>The debug firmware enables the <code class="docutils literal notranslate"><span class="pre">PRINTF</span></code> macro, however you have to define it
in your app’s Makefile. To do so, add this line in your Makefile: <code class="docutils literal notranslate"><span class="pre">DEFINES</span>
<span class="pre">+=</span> <span class="pre">HAVE_SPRINTF</span> <span class="pre">HAVE_PRINTF</span> <span class="pre">PRINTF=screen_printf</span></code></p>
<p>Usually, <code class="docutils literal notranslate"><span class="pre">PRINTF</span></code> is already defined to void with this line <code class="docutils literal notranslate"><span class="pre">DEFINES</span>&#160;&#160; <span class="pre">+=</span>
<span class="pre">PRINTF\(...\)=</span></code>. Check if <code class="docutils literal notranslate"><span class="pre">PRINTF</span></code> is already defined somewhere else in your
Makefile, and comment out this definition so it doesn’t override the one that
we just set.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The PRINTF macro is a debugging feature, and as such it is not intended for
use in production. When compiling an application for release purpose, please
verify that <code class="docutils literal notranslate"><span class="pre">PRINTF</span></code> is disabled in your Makefile. In other words, in case
of release compilation, put back the line <code class="docutils literal notranslate"><span class="pre">DEFINES</span>&#160;&#160; <span class="pre">+=</span> <span class="pre">PRINTF\(...\)=</span></code>
and comment out the other one.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code class="docutils literal notranslate"><span class="pre">PRINTF</span></code> macro can only be used in between successive calls to
<code class="docutils literal notranslate"><span class="pre">io_exchange</span></code>. Calling it outside of it will result in unexpected
behavior. Behind the scene, <code class="docutils literal notranslate"><span class="pre">PRINTF</span></code> sends a status on the <a class="reference external" href="https://ledger.readthedocs.io/en/latest/bolos/hardware_architecture.html#seproxyhal">SEPH</a>.
Only one status can be sent in a row, otherwise the SEPH crashes. For this
reason, don’t use <code class="docutils literal notranslate"><span class="pre">PRINTF</span></code> just after status-sending calls, such as
<code class="docutils literal notranslate"><span class="pre">UX_DISPLAY</span></code>. This macro packs a call to <cite>io_seproxyhal_display</cite> and is
often the reason for application crashes. Then is no other work around than
to move your call to <code class="docutils literal notranslate"><span class="pre">PRINTF</span></code> somewhere else in your code.</p>
</div>
<p>This macro can be used in your code like a classical <code class="docutils literal notranslate"><span class="pre">printf</span></code> function from
<code class="docutils literal notranslate"><span class="pre">stdio.h</span></code>. However, it is improved with a neat feature to easily print byte
arrays:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">uint8_t</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">};</span>

<span class="c1">// PRINTF(string, array length, array);</span>
<span class="c1">// .*H for uppercase, .*h for lowercase</span>
<span class="n">PRINTF</span><span class="p">(</span><span class="s">&quot;What a lovely buffer:</span><span class="se">\n</span><span class="s"> %.*H </span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
<span class="n">PRINTF</span><span class="p">(</span><span class="s">&quot;I prefer it lower-cased:</span><span class="se">\n</span><span class="s"> %.*h </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
</pre></div>
</div>
<div class="figure align-center" id="id3">
<a class="reference internal image-reference" href="../_images/deadbeef.png"><img alt="../_images/deadbeef.png" src="../_images/deadbeef.png" style="width: 551.0px; height: 115.0px;" /></a>
<p class="caption"><span class="caption-text">Result of the example code printed inside a terminal</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="console-printing">
<h2>Console Printing<a class="headerlink" href="#console-printing" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">PRINTF</span></code> macro triggers messages from the MCU to the host computer
through the USB link. We use <a class="reference external" href="https://drive.google.com/open?id=16D5vlrbczmBxqpDJml6QUV0RGWs7aZeZ">USBTool</a> to read
these messages and print their payload in a terminal.</p>
<p>Unzip the file and execute this command: <code class="docutils literal notranslate"><span class="pre">./usbtool</span> <span class="pre">-v</span> <span class="pre">0x2c97</span> <span class="pre">log</span></code></p>
<p>Now you can launch your app on your Nano S, and every <code class="docutils literal notranslate"><span class="pre">PRINTF</span></code> will end up
printed on the host computer, allowing you to debug your program more easily.</p>
</div>
<div class="section" id="pin-bypass">
<h2>PIN bypass<a class="headerlink" href="#pin-bypass" title="Permalink to this headline">¶</a></h2>
<p>In Ledger app development, it is necessary to enter your PIN code each time you
install an unsigned app. In order to do testing during development, this means
developers wind up using many painful button presses entering a PIN code
compared to relatively few testing their own application code. The Ledger OS
(BOLOS) supports installing a custom developer certificate. By installing a
custom certificate once on your device you can avoid having to retype your PIN
each time you adjust your app. Here are the steps for the Ledger Nano S:</p>
<ol class="arabic">
<li><p>Generate a public / private keypair using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>foo@bar:~$ python -m ledgerblue.genCAPair
Public key : 0495331cb86e961fc9cb5792a97737e4204b58be99321dcec463cec3057b3304e9875614004e6e540ab0610a1339fae22df6f6f3ec594912b409d69b72f0eaf390
Private key: 6c1f1df852255e113b23c2e977d6b5c3ea2aaf411f05a5fdab87a3e8f44468ee
</pre></div>
</div>
</li>
</ol>
<p>2. Enter recovery mode on your Ledger Nano S. Do this by unplugging it then
holding down the right button (near the hinge, away from USB port) while
plugging it in again. <code class="docutils literal notranslate"><span class="pre">recovery</span> <span class="pre">mode</span></code> should then appear on the screen.
Enter your pin and continue.</p>
<p>3. Load your public key onto the Ledger Nano S. Paste the public key generated
at step 1 after <code class="docutils literal notranslate"><span class="pre">--public</span></code>. You may need to adjust the <code class="docutils literal notranslate"><span class="pre">--targetId</span></code>
constant to match your device. Find the right targetId for your device <a class="reference external" href="https://gist.github.com/TamtamHero/b7651ffe6f1e485e3886bf4aba673348">here</a>.
Notice that we must include  a <code class="docutils literal notranslate"><span class="pre">--name</span></code> parameter containing the name of the
custom certificate (any string will do):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">ledgerblue</span><span class="o">.</span><span class="n">setupCustomCA</span> <span class="o">--</span><span class="n">targetId</span> <span class="mh">0x31100004</span> <span class="o">--</span><span class="n">public</span> <span class="n">yourPublicKey</span> <span class="o">--</span><span class="n">name</span> <span class="n">dev</span>
</pre></div>
</div>
<p>If you receive the error <code class="docutils literal notranslate"><span class="pre">Invalid</span> <span class="pre">status</span> <span class="pre">6985</span></code> then please review
<a class="reference external" href="https://github.com/LedgerHQ/blue-loader-python/issues/42">this link</a> and then go
back to step 2. The above command is the simplest that can work however some
developers may wish to use the optional <code class="docutils literal notranslate"><span class="pre">--rootPrivateKey</span></code> option to specify
a secure channel encryption key (which is the private key generated at step 1)
or use the <code class="docutils literal notranslate"><span class="pre">--name</span></code> option for convenient labeling according to local
convention.</p>
<p>4. Once you have loaded your custom certificate, you can try to load an app you
compiled yourself onto your Ledger to see if you are able to bypass the PIN.
Before you try it, set the <code class="docutils literal notranslate"><span class="pre">SCP_PRIVKEY</span></code> environment variable to contain the
private key generated at step 1 in your shell or <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">SCP_PRIVKEY</span><span class="o">=</span><span class="n">yourPrivateKey</span>
</pre></div>
</div>
<p>and then rebuild/load your app.</p>
<p>For more information see
<a class="reference external" href="https://ledger.readthedocs.io/projects/blue-loader-python/en/0.1.16/script_reference.html#loadapp-py">loadApp-py</a></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>A side effect of installing a custom CA on your device is that it will from
now on fail to pass the Ledger Genuine Check, which is required to install
applications from the Ledger Live. To make it genuine again, you should
uninstall your custom CA and all the applications installed through it.</p>
</div>
<p>Uninstalling a custom CA is very quick:</p>
<p>1. Enter recovery mode on your Ledger Nano S. Do this by unplugging it then
holding down the right button (near the hinge, away from USB port) while
plugging it in again. <code class="docutils literal notranslate"><span class="pre">recovery</span> <span class="pre">mode</span></code> should then appear on the screen.
Enter your pin and continue.</p>
<ol class="arabic" start="2">
<li><p>Type this command in your terminal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>foo@bar:~$ python -m ledgerblue.resetCustomCA --targetId 0x31100004
</pre></div>
</div>
</li>
</ol>
<p>Find the right targetId for your device <a class="reference external" href="https://gist.github.com/TamtamHero/b7651ffe6f1e485e3886bf4aba673348">here</a>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="speculos.html" class="btn btn-neutral float-right" title="Emulating devices with Speculos" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="troubleshooting.html" class="btn btn-neutral float-left" title="Common Pitfalls and Troubleshooting" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2016 - 2019, Ledger Team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>