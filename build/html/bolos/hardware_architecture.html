

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Hardware Architecture &mdash; Ledger Documentation Hub 2 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Application Environment" href="application_environment.html" />
    <link rel="prev" title="BOLOS Features" href="features.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Ledger Documentation Hub
          

          
          </a>

          
            
            
              <div class="version">
                2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Background Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../background/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/personal_security_devices.html">Personal Security Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/master_seed.html">The Master Seed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/hd_keys.html">HD Key Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/hd_use_cases.html">Applications of HD Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/application_isolation.html">Application Isolation</a></li>
</ul>
<p class="caption"><span class="caption-text">BOLOS Platform</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="features.html">BOLOS Features</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Hardware Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#multiple-processors-secure-element-proxy">Multiple Processors: Secure Element Proxy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#seproxyhal">SEPROXYHAL</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="application_environment.html">Application Environment</a></li>
</ul>
<p class="caption"><span class="caption-text">Userspace Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace/setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace/writing_apps.html">Writing Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace/display_management.html">Display Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace/advanced_display_management.html">Advanced Display Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace/syscalls.html">Interaction Between BOLOS and Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace/application_structure.html">Application Structure and I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace/memory.html">Persistent Storage and PIC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace/alignment.html">Memory alignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace/troubleshooting.html">Common Pitfalls and Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace/debugging.html">Application Debug</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userspace/speculos.html">Emulating devices with Speculos</a></li>
</ul>
<p class="caption"><span class="caption-text">Additional Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../additional/publishing_an_app.html">Publishing an Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional/external_docs.html">External Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional/security_guidelines.html">Developing Secure Ledger Apps</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ledger Documentation Hub</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Hardware Architecture</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/bolos/hardware_architecture.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="hardware-architecture">
<h1>Hardware Architecture<a class="headerlink" href="#hardware-architecture" title="Permalink to this headline">¶</a></h1>
<p>Ledger devices have a very unique architecture in order to leverage the security
of the Secure Element while still being able to interface with many different
peripherals such as the screen, buttons, the host computer over USB, or
Bluetooth &amp; NFC in the case of the Ledger Blue. In order to accomplish this, we
attached an additional STM32 microcontroller (“the MCU”) to the Secure Element
(“the SE”) which acts as a “dumb router” between the Secure Element and the
peripherals. The microcontroller doesn’t perform any application logic and it
doesn’t store any of the cryptographic secrets used by BOLOS, it simply manages
the peripherals and notifies the Secure Element whenever new data is ready to be
received. BOLOS applications are executed entirely on the Secure Element. In
this section, we’ll take a look at the hardware architecture to better embrace
the hardware related constraints before analyzing their software implications.</p>
<div class="section" id="multiple-processors-secure-element-proxy">
<h2>Multiple Processors: Secure Element Proxy<a class="headerlink" href="#multiple-processors-secure-element-proxy" title="Permalink to this headline">¶</a></h2>
<div class="figure align-center" id="id1">
<img alt="Detailed BOLOS architecture" src="../_images/bolos_architecture.png" />
<p class="caption"><span class="caption-text">A detailed BOLOS architecture diagram</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>BOLOS is split between two hardware chips, one being secure (the ST31 Secure
Element), and the other having JTAG enabled and acting as a proxy (the STM32
MCU).</p>
<p>Furthermore, the Secure Element is also split into two parts: the firmware which
is under NDA and is therefore closed-source, and the SDK &amp; application-loaded
code which is open source friendly. The BOLOS firmware is responsible for
low-level I/O operations and implements the SE-MCU link (though the handling of
the protocol between the SE and the MCU is done by the currently running app).</p>
<p>BOLOS relies on the collaboration of both chips to empower Secure Element
applications. At first glance, and even at second and all following, the Secure
Element is a very powerful piece of hardware but lacks inputs / outputs. In our
architecture, we solved this problem by appending the MCU which is full of
inputs / outputs so it can act as a proxy for the Secure Element to explore new
horizons. In a sense, the MCU can be seen as a supercharged coprocessor of the
Secure Element. Not considering security implications (which is beyond the scope
of this section), and thanks to a simple asynchronous protocol, the Secure
Element drives the proxy.</p>
<p>The SE-MCU link protocol is called SEPROXYHAL or SEPH in source code and
documentation. The “HAL” stands for Hardware Abstraction Layer.</p>
</div>
<div class="section" id="seproxyhal">
<h2>SEPROXYHAL<a class="headerlink" href="#seproxyhal" title="Permalink to this headline">¶</a></h2>
<p>The SEPROXYHAL protocol is structured as a serialized list of three types of
packets: Events, Commands, and Statuses. Since SEPROXYHAL is the only channel
for the SE to communicate with the outside world, if there is an error at the
protocol level (such as the order or formatting of Events / Commands / Statuses
getting messed up), then the SE ends up completely isolated and unable to
communicate. When developing an application this is typically the most common
failure scenario. If this happens, the device must be rebooted to reset the
SEPROXYHAL protocol state. Hopefully, multiple levels of software guards are
implemented to avoid such cases.</p>
<p>The protocol works as follows:</p>
<ol class="arabic simple">
<li><p>The MCU sends an Event (button press, ticker, USB transfer, …).</p></li>
<li><p>The SE responds with a list of zero or more Commands in response to the
Event.</p></li>
<li><p>The SE sends a Status indicating that the Event is fully processed and waits
for another Event.</p></li>
</ol>
<div class="figure align-center" id="id2">
<img alt="SEPROXYHAL protocol concept" src="../_images/seproxyhal.png" />
<p class="caption"><span class="caption-text">SEPROXYHAL protocol concept</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>As a matter of fact, due to buffer size, requests to display something to the
screen are sent using a Status. When the MCU has finished processing the Display
Status, it issues a Display Processed Event indicating that it is ready to
receive another Display Status. As a result, displaying multiple elements on the
screen (in order to build an entire user interface) must be done asynchronously
from the core application logic. This process is facilitated by a UX helper
implemented in the SDK, which will be discussed further in the next chapter.</p>
<p>The SE throws an exception to applications willing to send more than one Status
in a row, without a new Event being fetched in between.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="application_environment.html" class="btn btn-neutral float-right" title="Application Environment" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="features.html" class="btn btn-neutral float-left" title="BOLOS Features" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2016 - 2019, Ledger Team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>